databaseChangeLog:
  - changeSet:
      id: 007-seed-production-year
      author: metadata
      context: seed
      preConditions:
        - onFail: MARK_RAN
        - tableExists: { tableName: production_year }
        - tableExists: { tableName: make }
        - tableExists: { tableName: model }
        - tableExists: { tableName: generation }

      changes:
        # 1. Create staging table
        - createTable:
            tableName: stg_production_year
            columns:
              - column: { name: id,                type: BIGINT }
              - column: { name: id_car_make,       type: BIGINT }
              - column: { name: id_car_model,      type: BIGINT }
              - column: { name: id_car_generation, type: BIGINT }
              - column: { name: production_year,   type: INTEGER }

        # 2. Load data
        - loadData:
            tableName: stg_production_year
            file: classpath:db/changelog/data/year.csv
            relativeToChangelogFile: false
            encoding: UTF-8
            separator: ';'
            usePreparedStatements: true
            columns:
              - column: { header: id,                name: id,                type: NUMERIC }
              - column: { header: id_car_make,       name: id_car_make,       type: NUMERIC }
              - column: { header: id_car_model,      name: id_car_model,      type: NUMERIC }
              - column: { header: id_car_generation, name: id_car_generation, type: NUMERIC }
              - column: { header: production_year,   name: production_year,   type: NUMERIC }

        # 3. Insert into main table
        - sql:
            splitStatements: false
            sql: |
              INSERT INTO production_year (
                id, make_id, model_id, generation_id, production_year
              )
              SELECT
                s.id,
                s.id_car_make,
                s.id_car_model,
                s.id_car_generation,
                s.production_year
              FROM stg_production_year s
              WHERE NOT EXISTS (
                SELECT 1
                FROM production_year py
                WHERE py.id = s.id
              );

        # 4. Drop staging table
        - dropTable:
            tableName: stg_production_year
