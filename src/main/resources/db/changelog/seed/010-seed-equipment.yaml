databaseChangeLog:
  - changeSet:
      id: 010-create-equipment
      author: metadata
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: equipment

      changes:
        - createTable:
            tableName: equipment
            remarks: "Defines available equipment/trim levels for a specific modification"
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_equipment
                    nullable: false

              - column:
                  name: modification_id
                  type: BIGINT
                  constraints:
                    nullable: false

              - column:
                  name: name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false

              - column:
                  name: price_min
                  type: 'NUMERIC(18,2)'

              - column:
                  name: production_year
                  type: INTEGER

              - column:
                  name: date_create
                  type: TIMESTAMP

              - column:
                  name: date_update
                  type: TIMESTAMP

              - column:
                  name: type_id
                  type: BIGINT

        - addForeignKeyConstraint:
            baseTableName: equipment
            baseColumnNames: modification_id
            referencedTableName: modification
            referencedColumnNames: id
            constraintName: fk_equipment_modification
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: equipment
            baseColumnNames: type_id
            referencedTableName: type
            referencedColumnNames: id
            constraintName: fk_equipment_type
            onDelete: SET NULL

        - createIndex:
            tableName: equipment
            indexName: ix_equipment_modification
            columns:
              - column:
                  name: modification_id

        - createIndex:
            tableName: equipment
            indexName: ix_equipment_type
            columns:
              - column:
                  name: type_id

  - changeSet:
      id: 010-seed-equipment
      author: metadata
      context: seed
      preConditions:
        - onFail: MARK_RAN
        - tableExists: { tableName: equipment }
        - tableExists: { tableName: modification }

      changes:
        - createTable:
            tableName: stg_equipment
            columns:
              - column: { name: id_car_equipment,    type: BIGINT }
              - column: { name: id_car_modification, type: BIGINT }
              - column: { name: name,                type: VARCHAR(255) }
              - column: { name: price_min,           type: 'NUMERIC(18,2)' }
              - column: { name: production_year,     type: INTEGER }
              - column: { name: date_create,         type: BIGINT }
              - column: { name: date_update,         type: BIGINT }
              - column: { name: id_car_type,         type: BIGINT }

        - loadData:
            tableName: stg_equipment
            file: classpath:db/changelog/data/equipment.csv
            relativeToChangelogFile: false
            encoding: UTF-8
            separator: ';'
            usePreparedStatements: true
            columns:
              - column: { header: id_car_equipment,    name: id_car_equipment,    type: NUMERIC }
              - column: { header: id_car_modification, name: id_car_modification, type: NUMERIC }
              - column: { header: name,                name: name,                type: STRING  }
              - column: { header: price_min,           name: price_min,           type: NUMERIC }
              - column: { header: year,                name: production_year,     type: NUMERIC }
              - column: { header: date_create,         name: date_create,         type: NUMERIC }
              - column: { header: date_update,         name: date_update,         type: NUMERIC }
              - column: { header: id_car_type,         name: id_car_type,         type: NUMERIC }

        ## PostgreSQL insert
        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              INSERT INTO equipment (
                id, modification_id, name,
                price_min, production_year,
                date_create, date_update, type_id
              )
              SELECT
                s.id_car_equipment,
                s.id_car_modification,
                s.name,
                s.price_min,
                s.production_year,
                TO_TIMESTAMP(NULLIF(s.date_create, 0)),
                TO_TIMESTAMP(NULLIF(s.date_update, 0)),
                s.id_car_type
              FROM stg_equipment s
              WHERE NOT EXISTS (
                SELECT 1 FROM equipment e WHERE e.id = s.id_car_equipment
              );

        ## H2 insert
        - sql:
            dbms: h2
            splitStatements: false
            sql: |
              INSERT INTO equipment (
                id, modification_id, name,
                price_min, production_year,
                date_create, date_update, type_id
              )
              SELECT
                s.id_car_equipment,
                s.id_car_modification,
                s.name,
                s.price_min,
                s.production_year,
                CASE WHEN s.date_create = 0 THEN NULL
                     ELSE DATEADD('SECOND', s.date_create, TIMESTAMP '1970-01-01 00:00:00') END,
                CASE WHEN s.date_update = 0 THEN NULL
                     ELSE DATEADD('SECOND', s.date_update, TIMESTAMP '1970-01-01 00:00:00') END,
                s.id_car_type
              FROM stg_equipment s
              WHERE NOT EXISTS (
                SELECT 1 FROM equipment e WHERE e.id = s.id_car_equipment
              );

        - dropTable:
            tableName: stg_equipment
