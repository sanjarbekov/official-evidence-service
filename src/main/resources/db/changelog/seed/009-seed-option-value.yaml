databaseChangeLog:
  - changeSet:
      id: 009-seed-option-value
      author: metadata
      context: seed
      preConditions:
        - onFail: MARK_RAN
        - tableExists: { tableName: option_value }
        - tableExists: { tableName: option }
        - tableExists: { tableName: equipment }

      changes:
        # 1. Create staging table
        - createTable:
            tableName: stg_option_value
            columns:
              - column: { name: id_car_option_value, type: BIGINT }
              - column: { name: id_car_option,       type: BIGINT }
              - column: { name: id_car_equipment,    type: BIGINT }
              - column: { name: is_base,             type: BOOLEAN }
              - column: { name: date_create,         type: BIGINT }
              - column: { name: date_update,         type: BIGINT }
              - column: { name: id_car_type,         type: BIGINT }

        # 2. Load data
        - loadData:
            tableName: stg_option_value
            file: classpath:db/changelog/data/option_value.csv
            relativeToChangelogFile: false
            encoding: UTF-8
            separator: ','
            usePreparedStatements: true
            columns:
              - column: { header: id_car_option_value, name: id_car_option_value, type: NUMERIC }
              - column: { header: id_car_option,       name: id_car_option,       type: NUMERIC }
              - column: { header: id_car_equipment,    name: id_car_equipment,    type: NUMERIC }
              - column: { header: is_base,             name: is_base,             type: BOOLEAN }
              - column: { header: date_create,         name: date_create,         type: NUMERIC }
              - column: { header: date_update,         name: date_update,         type: NUMERIC }
              - column: { header: id_car_type,         name: id_car_type,         type: NUMERIC }

        # 3. Insert for PostgreSQL
        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              INSERT INTO option_value (
                id, option_id, equipment_id,
                is_base, date_create, date_update, type_id
              )
              SELECT
                s.id_car_option_value,
                s.id_car_option,
                s.id_car_equipment,
                s.is_base,
                TO_TIMESTAMP(NULLIF(s.date_create, 0)),
                TO_TIMESTAMP(NULLIF(s.date_update, 0)),
                s.id_car_type
              FROM stg_option_value s
              WHERE NOT EXISTS (
                SELECT 1 FROM option_value v WHERE v.id = s.id_car_option_value
              );

        # 4. Insert for H2
        - sql:
            dbms: h2
            splitStatements: false
            sql: |
              INSERT INTO option_value (
                id, option_id, equipment_id,
                is_base, date_create, date_update, type_id
              )
              SELECT
                s.id_car_option_value,
                s.id_car_option,
                s.id_car_equipment,
                s.is_base,
                CASE WHEN s.date_create = 0 THEN NULL
                     ELSE DATEADD('SECOND', s.date_create, TIMESTAMP '1970-01-01 00:00:00') END,
                CASE WHEN s.date_update = 0 THEN NULL
                     ELSE DATEADD('SECOND', s.date_update, TIMESTAMP '1970-01-01 00:00:00') END,
                s.id_car_type
              FROM stg_option_value s
              WHERE NOT EXISTS (
                SELECT 1 FROM option_value v WHERE v.id = s.id_car_option_value
              );

        # 5. Drop staging table
        - dropTable:
            tableName: stg_option_value
