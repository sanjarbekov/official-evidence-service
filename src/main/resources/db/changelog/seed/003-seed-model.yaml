databaseChangeLog:
  - changeSet:
      id: 003-seed-model
      author: metadata
      context: seed
      preConditions:
        - onFail: MARK_RAN
        - tableExists: { tableName: model }
        - tableExists: { tableName: make }
        - tableExists: { tableName: type }

      changes:
        # 1. Temporary staging table
        - createTable:
            tableName: stg_model
            columns:
              - column: { name: id_car_model,  type: BIGINT }
              - column: { name: id_car_make,   type: BIGINT }
              - column: { name: name,          type: VARCHAR(255) }
              - column: { name: name_rus,      type: VARCHAR(255) }
              - column: { name: date_create,   type: BIGINT }   # epoch seconds
              - column: { name: date_update,   type: BIGINT }   # epoch seconds
              - column: { name: id_car_type,   type: BIGINT }

        # 2. Load CSV into staging
        - loadData:
            tableName: stg_model
            file: classpath:db/changelog/data/model.csv
            relativeToChangelogFile: false
            encoding: UTF-8
            separator: ';'
            usePreparedStatements: true
            columns:
              - column: { header: id_car_model, name: id_car_model, type: NUMERIC }
              - column: { header: id_car_make,  name: id_car_make,  type: NUMERIC }
              - column: { header: name,         name: name,         type: STRING  }
              - column: { header: name_rus,     name: name_rus,     type: STRING  }
              - column: { header: date_create,  name: date_create,  type: NUMERIC }
              - column: { header: date_update,  name: date_update,  type: NUMERIC }
              - column: { header: id_car_type,  name: id_car_type,  type: NUMERIC }

        # 3. Insert into main table (PostgreSQL)
        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              INSERT INTO model (id, name, name_rus, date_create, date_update, make_id, type_id)
              SELECT
                s.id_car_model,
                s.name,
                s.name_rus,
                TO_TIMESTAMP(NULLIF(s.date_create, 0)),
                TO_TIMESTAMP(NULLIF(s.date_update, 0)),
                s.id_car_make,
                s.id_car_type
              FROM stg_model s
              WHERE NOT EXISTS (
                SELECT 1 FROM model m WHERE m.id = s.id_car_model
              );

        # 4. Insert into main table (H2)
        - sql:
            dbms: h2
            splitStatements: false
            sql: |
              INSERT INTO model (id, name, name_rus, date_create, date_update, make_id, type_id)
              SELECT
                s.id_car_model,
                s.name,
                s.name_rus,
                CASE WHEN s.date_create = 0 THEN NULL
                     ELSE TIMESTAMPADD(SECOND, s.date_create, TIMESTAMP '1970-01-01 00:00:00') END,
                CASE WHEN s.date_update = 0 THEN NULL
                     ELSE TIMESTAMPADD(SECOND, s.date_update, TIMESTAMP '1970-01-01 00:00:00') END,
                s.id_car_make,
                s.id_car_type
              FROM stg_model s
              WHERE NOT EXISTS (
                SELECT 1 FROM model m WHERE m.id = s.id_car_model
              );

        # 5. Cleanup
        - dropTable:
            tableName: stg_model
            cascadeConstraints: true
