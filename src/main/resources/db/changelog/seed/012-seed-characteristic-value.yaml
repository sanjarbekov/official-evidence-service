databaseChangeLog:
  - changeSet:
      id: 012-seed-characteristic-value
      author: metadata
      context: seed
      preConditions:
        - onFail: MARK_RAN
        - tableExists: { tableName: characteristic_value }
        - tableExists: { tableName: modification }
        - tableExists: { tableName: characteristic }

      changes:
        # =========================================================
        # 1. STAGING TABLE
        # =========================================================
        - createTable:
            tableName: stg_characteristic_value
            columns:
              - column:
                  name: id_car_characteristic_value
                  type: BIGINT
                  constraints:
                    nullable: false

              - column:
                  name: id_car_modification
                  type: BIGINT
                  constraints:
                    nullable: false

              - column:
                  name: id_car_characteristic
                  type: BIGINT
                  constraints:
                    nullable: false

              - column:
                  name: val
                  type: VARCHAR(1024)

              - column:
                  name: unit
                  type: VARCHAR(32)

              - column:
                  name: date_create
                  type: BIGINT

              - column:
                  name: date_update
                  type: BIGINT

              - column:
                  name: id_car_type
                  type: BIGINT

        # =========================================================
        # 2. LOAD CSVs (value â†’ val mapping)
        # =========================================================
        - loadData:
            tableName: stg_characteristic_value
            file: classpath:db/changelog/data/characteristic_value_1.csv
            relativeToChangelogFile: false
            encoding: UTF-8
            separator: ';'
            usePreparedStatements: true
            columns:
              - column: { header: id_car_characteristic_value, name: id_car_characteristic_value, type: NUMERIC }
              - column: { header: id_car_modification,        name: id_car_modification,        type: NUMERIC }
              - column: { header: id_car_characteristic,      name: id_car_characteristic,      type: NUMERIC }
              - column: { header: value,                      name: val,                        type: STRING }
              - column: { header: unit,                       name: unit,                       type: STRING }
              - column: { header: date_create,               name: date_create,               type: NUMERIC }
              - column: { header: date_update,               name: date_update,               type: NUMERIC }
              - column: { header: id_car_type,               name: id_car_type,               type: NUMERIC }

        # --- CSV 2 .. 35 follow same pattern ---

        # =========================================================
        # 3. POSTGRESQL INSERT
        # =========================================================
        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              INSERT INTO characteristic_value (
                id, modification_id, characteristic_id,
                val, unit, date_create, date_update, type_id
              )
              SELECT
                s.id_car_characteristic_value,
                s.id_car_modification,
                s.id_car_characteristic,
                s.val,
                s.unit,
                TO_TIMESTAMP(NULLIF(s.date_create, 0)),
                TO_TIMESTAMP(NULLIF(s.date_update, 0)),
                s.id_car_type
              FROM stg_characteristic_value s
              WHERE NOT EXISTS (
                SELECT 1 FROM characteristic_value v
                WHERE v.id = s.id_car_characteristic_value
              );

        # =========================================================
        # 4. H2 INSERT
        # =========================================================
        - sql:
            dbms: h2
            splitStatements: false
            sql: |
              INSERT INTO characteristic_value (
                id, modification_id, characteristic_id,
                val, unit, date_create, date_update, type_id
              )
              SELECT
                s.id_car_characteristic_value,
                s.id_car_modification,
                s.id_car_characteristic,
                s.val,
                s.unit,
                CASE
                  WHEN s.date_create = 0 THEN NULL
                  ELSE DATEADD('SECOND', s.date_create,
                       TIMESTAMP '1970-01-01 00:00:00')
                END,
                CASE
                  WHEN s.date_update = 0 THEN NULL
                  ELSE DATEADD('SECOND', s.date_update,
                       TIMESTAMP '1970-01-01 00:00:00')
                END,
                s.id_car_type
              FROM stg_characteristic_value s
              WHERE NOT EXISTS (
                SELECT 1 FROM characteristic_value v
                WHERE v.id = s.id_car_characteristic_value
              );

        # =========================================================
        # 5. CLEANUP
        # =========================================================
        - dropTable:
            tableName: stg_characteristic_value
            cascadeConstraints: true
