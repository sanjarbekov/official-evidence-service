databaseChangeLog:
  - changeSet:
      id: 006-seed-modification
      author: metadata
      context: seed
      preConditions:
        - onFail: MARK_RAN
        - tableExists: { tableName: modification }
        - tableExists: { tableName: series }
        - tableExists: { tableName: model }

      changes:
        # 1. Create staging table
        - createTable:
            tableName: stg_modification
            columns:
              - column: { name: id_car_modification,     type: BIGINT }
              - column: { name: id_car_serie,            type: BIGINT }
              - column: { name: id_car_model,            type: BIGINT }
              - column: { name: name,                    type: VARCHAR(255) }
              - column: { name: start_production_year,   type: INTEGER }
              - column: { name: end_production_year,     type: INTEGER }
              - column: { name: date_create,             type: BIGINT }
              - column: { name: date_update,             type: BIGINT }
              - column: { name: id_car_type,             type: BIGINT }

        # 2. Load data
        - loadData:
            tableName: stg_modification
            file: classpath:db/changelog/data/modification.csv
            relativeToChangelogFile: false
            encoding: UTF-8
            separator: ';'
            usePreparedStatements: true
            columns:
              - column: { header: id_car_modification,     name: id_car_modification,     type: NUMERIC }
              - column: { header: id_car_serie,            name: id_car_serie,            type: NUMERIC }
              - column: { header: id_car_model,            name: id_car_model,            type: NUMERIC }
              - column: { header: name,                    name: name,                    type: STRING  }
              - column: { header: start_production_year,   name: start_production_year,   type: NUMERIC }
              - column: { header: end_production_year,     name: end_production_year,     type: NUMERIC }
              - column: { header: date_create,             name: date_create,             type: NUMERIC }
              - column: { header: date_update,             name: date_update,             type: NUMERIC }
              - column: { header: id_car_type,             name: id_car_type,             type: NUMERIC }

        # 3. Insert PostgreSQL
        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              INSERT INTO modification (
                id, name, start_production_year, end_production_year, date_create, date_update,
                series_id, model_id, type_id
              )
              SELECT
                s.id_car_modification,
                s.name,
                s.start_production_year,
                s.end_production_year,
                TO_TIMESTAMP(NULLIF(s.date_create, 0)),
                TO_TIMESTAMP(NULLIF(s.date_update, 0)),
                s.id_car_serie,
                s.id_car_model,
                s.id_car_type
              FROM stg_modification s
              WHERE NOT EXISTS (
                SELECT 1 FROM modification m WHERE m.id = s.id_car_modification
              );

        # 4. Insert H2
        - sql:
            dbms: h2
            splitStatements: false
            sql: |
              INSERT INTO modification (
                id, name, start_production_year, end_production_year, date_create, date_update,
                series_id, model_id, type_id
              )
              SELECT
                s.id_car_modification,
                s.name,
                s.start_production_year,
                s.end_production_year,
                CASE WHEN s.date_create = 0 THEN NULL
                     ELSE DATEADD('SECOND', s.date_create, TIMESTAMP '1970-01-01 00:00:00') END,
                CASE WHEN s.date_update = 0 THEN NULL
                     ELSE DATEADD('SECOND', s.date_update, TIMESTAMP '1970-01-01 00:00:00') END,
                s.id_car_serie,
                s.id_car_model,
                s.id_car_type
              FROM stg_modification s
              WHERE NOT EXISTS (
                SELECT 1 FROM modification m WHERE m.id = s.id_car_modification
              );

        # 5. Drop staging
        - dropTable:
            tableName: stg_modification
