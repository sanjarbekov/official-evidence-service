databaseChangeLog:
  - changeSet:
      id: 011-seed-characteristic
      author: metadata
      context: seed
      preConditions:
        - onFail: MARK_RAN
        - tableExists: { tableName: characteristic }
        - tableExists: { tableName: type }

      changes:

        # 1. Create staging table
        - createTable:
            tableName: stg_characteristic
            columns:
              - column: { name: id_car_characteristic, type: BIGINT }
              - column: { name: name,                 type: VARCHAR(255) }
              - column: { name: id_parent,            type: BIGINT }
              - column: { name: date_create,          type: BIGINT }
              - column: { name: date_update,          type: BIGINT }
              - column: { name: id_car_type,          type: BIGINT }

        # 2. Load CSV
        - loadData:
            tableName: stg_characteristic
            file: classpath:db/changelog/data/characteristic.csv
            encoding: UTF-8
            separator: ';'
            usePreparedStatements: true
            columns:
              - column: { header: id_car_characteristic, name: id_car_characteristic, type: NUMERIC }
              - column: { header: name,                 name: name,                 type: STRING }
              - column: { header: id_parent,            name: id_parent,            type: NUMERIC }
              - column: { header: date_create,          name: date_create,          type: NUMERIC }
              - column: { header: date_update,          name: date_update,          type: NUMERIC }
              - column: { header: id_car_type,          name: id_car_type,          type: NUMERIC }

        #########################################################
        # 3. Insert ONLY root characteristics (id_parent IS NULL)
        #########################################################

        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              INSERT INTO characteristic (
                id, name, parent_id, date_create, date_update, type_id
              )
              SELECT
                s.id_car_characteristic,
                s.name,
                NULL,
                TO_TIMESTAMP(NULLIF(s.date_create, 0)),
                TO_TIMESTAMP(NULLIF(s.date_update, 0)),
                s.id_car_type
              FROM stg_characteristic s
              WHERE s.id_parent IS NULL
                AND NOT EXISTS (
                  SELECT 1 FROM characteristic c WHERE c.id = s.id_car_characteristic
                );

        - sql:
            dbms: h2
            splitStatements: false
            sql: |
              INSERT INTO characteristic (
                id, name, parent_id, date_create, date_update, type_id
              )
              SELECT
                s.id_car_characteristic,
                s.name,
                NULL,
                CASE WHEN s.date_create = 0 THEN NULL
                     ELSE DATEADD('SECOND', s.date_create, TIMESTAMP '1970-01-01 00:00:00') END,
                CASE WHEN s.date_update = 0 THEN NULL
                     ELSE DATEADD('SECOND', s.date_update, TIMESTAMP '1970-01-01 00:00:00') END,
                s.id_car_type
              FROM stg_characteristic s
              WHERE s.id_parent IS NULL
                AND NOT EXISTS (
                  SELECT 1 FROM characteristic c WHERE c.id = s.id_car_characteristic
                );

        #########################################################
        # 4. Insert CHILD characteristics (id_parent NOT NULL)
        #########################################################

        - sql:
            dbms: postgresql
            splitStatements: false
            sql: |
              INSERT INTO characteristic (
                id, name, parent_id, date_create, date_update, type_id
              )
              SELECT
                s.id_car_characteristic,
                s.name,
                s.id_parent,
                TO_TIMESTAMP(NULLIF(s.date_create, 0)),
                TO_TIMESTAMP(NULLIF(s.date_update, 0)),
                s.id_car_type
              FROM stg_characteristic s
              WHERE s.id_parent IS NOT NULL
                AND NOT EXISTS (
                  SELECT 1 FROM characteristic c WHERE c.id = s.id_car_characteristic
                );

        - sql:
            dbms: h2
            splitStatements: false
            sql: |
              INSERT INTO characteristic (
                id, name, parent_id, date_create, date_update, type_id
              )
              SELECT
                s.id_car_characteristic,
                s.name,
                s.id_parent,
                CASE WHEN s.date_create = 0 THEN NULL
                     ELSE DATEADD('SECOND', s.date_create, TIMESTAMP '1970-01-01 00:00:00') END,
                CASE WHEN s.date_update = 0 THEN NULL
                     ELSE DATEADD('SECOND', s.date_update, TIMESTAMP '1970-01-01 00:00:00') END,
                s.id_car_type
              FROM stg_characteristic s
              WHERE s.id_parent IS NOT NULL
                AND NOT EXISTS (
                  SELECT 1 FROM characteristic c WHERE c.id = s.id_car_characteristic
                );

        # 5. Drop staging
        - dropTable:
            tableName: stg_characteristic
