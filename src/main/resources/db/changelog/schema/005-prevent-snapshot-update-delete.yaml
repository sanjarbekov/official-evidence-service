databaseChangeLog:
  - changeSet:
      id: 005-prevent-update-delete-official-evidence-snapshot
      author: sanjar.bekov
      context: schema
      changes:

        # =========================================
        # FUNCTION: prevent UPDATE / DELETE
        # =========================================
        - sql:
            splitStatements: false
            sql: |
              CREATE OR REPLACE FUNCTION prevent_official_evidence_snapshot_mutation()
              RETURNS trigger AS $$
              BEGIN
                  RAISE EXCEPTION
                      'official_evidence_snapshot is immutable and cannot be %',
                      TG_OP
                      USING ERRCODE = '45000';
              END;
              $$ LANGUAGE plpgsql;

        # =========================================
        # TRIGGER: BEFORE UPDATE OR DELETE
        # =========================================
        - sql:
            splitStatements: false
            sql: |
              CREATE TRIGGER trg_prevent_official_evidence_snapshot_mutation
              BEFORE UPDATE OR DELETE
              ON official_evidence_snapshot
              FOR EACH ROW
              EXECUTE FUNCTION prevent_official_evidence_snapshot_mutation();